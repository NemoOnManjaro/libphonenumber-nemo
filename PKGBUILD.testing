# Maintainer: Jan Alexander Steffens (heftig) <heftig@archlinux.org>

pkgname=libphonenumber-nemo
pkgver=9.0.13
pkgrel=1
epoch=1
pkgdesc="Google's common library for parsing, formatting, and validating international phone numbers"
url="https://github.com/google/libphonenumber"
arch=('x86_64' 'aarch64')
license=(Apache)
depends=('protobuf')
depends_x86_64=('icu=76.1'
    'abseil-cpp=20250814.0')
depends_aarch64=('icu=76.1'
    'abseil-cpp=20250512.1')

makedepends=(cmake gtest)
source=("https://github.com/google/libphonenumber/archive/refs/tags/v${pkgver}.tar.gz"
    "0001-Fix-geocoding-build-when-static-libraries-are-off.patch")
sha256sums=('46400323d2df4fdefd57bc46a34111dc2c4612da62ecd0cedebff5ad94e49b0b'
            'f30e041e0030c483e1fcaa6ba365ea126473faa6aa11ca1bfd892393f68405db')
provides=("libphonenumber")

prepare() {
  cd libphonenumber-$pkgver
  sed -e 's|CMAKE_CXX_STANDARD 11|CMAKE_CXX_STANDARD 17|' -i tools/cpp/CMakeLists.txt # Fix build with abseil-cpp 2023
  patch -p1 --input="${srcdir}/0001-Fix-geocoding-build-when-static-libraries-are-off.patch"
}

build() {
  cd libphonenumber-$pkgver

  cmake -S cpp -B build \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_CXX_STANDARD=17 \
    -DCMAKE_INSTALL_LIBDIR=lib \
    -DABSL_PROPAGATE_CXX_STD=ON \
    -DREGENERATE_METADATA=OFF \
    -DBUILD_STATIC_LIB=OFF \
    -DUSE_ICU_REGEXP=ON \
    -DUSE_LITE_METADATA=ON \
    -DUSE_RE2=OFF \
    -DUSE_PROTOBUF_LITE=ON \
    -DBUILD_GEOCODER=ON \
    -DUSE_BOOST=OFF \
    -DUSE_STDMUTEX=ON \
    -DBUILD_TESTING=OFF

  cmake --build build -v
}

package() {
  cd libphonenumber-$pkgver
  depends+=(libicu{uc,i18n}.so libprotobuf.so libboost_thread.so)
  provides+=(libgeocoding.so libphonenumber.so)

  DESTDIR="$pkgdir" cmake --install build
}
